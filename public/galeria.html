<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Galer√≠a de Fotos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1>üì∑ Galer√≠a</h1>
      <button id="btnLogout" class="btn btn-danger">Cerrar Sesi√≥n</button>
    </div>

    <!-- Formulario para subir foto -->
    <form id="formFoto" class="mb-4">
      <input type="text" id="titulo" class="form-control mb-2" placeholder="T√≠tulo" required>
      <input type="text" id="descripcion" class="form-control mb-2" placeholder="Descripci√≥n">
      <input type="file" id="imagen" class="form-control mb-2" accept="image/*" required>
      <button type="submit" class="btn btn-primary w-100">Subir Foto</button>
    </form>

    <!-- Contenedor de la galer√≠a -->
    <div id="galeria" class="row"></div>
  </div>

  <script>
    const token = localStorage.getItem('token');
    if (!token) {
      alert("‚ö†Ô∏è Debes iniciar sesi√≥n primero");
      location.href = "login.html";
    }

    // Cerrar sesi√≥n
    document.getElementById("btnLogout").addEventListener("click", () => {
      localStorage.removeItem("token");
      location.href = "login.html";
    });

    // Subir foto
    document.getElementById("formFoto").addEventListener("submit", async (e) => {
      e.preventDefault();

      const formData = new FormData();
      formData.append("titulo", document.getElementById("titulo").value);
      formData.append("descripcion", document.getElementById("descripcion").value);
      formData.append("imagen", document.getElementById("imagen").files[0]);

      const res = await fetch("http://localhost:3000/api/fotos", {
        method: "POST",
        headers: { "Authorization": "Bearer " + token },
        body: formData
      });

      if (res.ok) {
        alert("‚úÖ Foto subida correctamente");
        cargarFotos();
        document.getElementById("formFoto").reset();
      } else {
        const err = await res.json();
        alert("‚ùå " + (err.error || err.msg || "Error al subir foto"));
      }
    });

    // Cargar galer√≠a
    async function cargarFotos() {
      const res = await fetch("http://localhost:3000/api/fotos", {
        headers: { "Authorization": "Bearer " + token }
      });

      if (!res.ok) {
        alert("‚ö†Ô∏è Sesi√≥n expirada. Vuelve a iniciar sesi√≥n.");
        localStorage.removeItem("token");
        location.href = "login.html";
        return;
      }

      const fotos = await res.json();
      const contenedor = document.getElementById("galeria");
      contenedor.innerHTML = "";

      fotos.forEach(foto => {
        const div = document.createElement("div");
        div.className = "col-md-4 mb-4";
        div.innerHTML = `
          <div class="card">
            <img src="${foto.url}" class="card-img-top" alt="${foto.titulo}">
            <div class="card-body">
              <h5 class="card-title">${foto.titulo}</h5>
              <p class="card-text">${foto.descripcion || ""}</p>
              <button class="btn btn-danger btn-sm" onclick="eliminarFoto('${foto._id}')">Eliminar</button>
            </div>
          </div>
        `;
        contenedor.appendChild(div);
      });
    }

    // Eliminar foto
    async function eliminarFoto(id) {
      if (!confirm("¬øSeguro que deseas eliminar esta foto?")) return;

      const res = await fetch(`http://localhost:3000/api/fotos/${id}`, {
        method: "DELETE",
        headers: { "Authorization": "Bearer " + token }
      });

      if (res.ok) {
        alert("üóëÔ∏è Foto eliminada");
        cargarFotos();
      } else {
        alert("‚ùå Error al eliminar");
      }
    }

    // Inicializar galer√≠a
    cargarFotos();
  </script>
</body>
</html>
